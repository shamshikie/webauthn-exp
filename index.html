<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="next-size-adjust" content="" />
    <title>ログイン</title>
    <meta name="description" content="ログイン" />
  </head>
  <body class="__variable_5cfdac __variable_9a8899 antialiased">
    <div class="max-w-md w-full bg-white rounded-2xl shadow-xl p-8">
      <h1 class="text-3xl font-bold text-gray-800 mb-2">パスキーログイン</h1>
    </div>
    <form class="space-y-6">
      <div>
        <label for="email" class="block text-sm font-medium text-gray-700 mb-2"
          >メールアドレス</label
        >
        <div class="relative">
          <input
            type="email"
            id="email"
            class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all duration-200"
            placeholder="your@email.com"
            autocomplete="username webauthn"
            required
            autofocus
          />
        </div>
      </div>
      <button
        type="submit"
        class="w-full bg-blue-600 hover:bg-blue-700 disabled:bg-blue-300 text-white font-medium py-3 px-4 rounded-xl transition-colors duration-200 flex items-center justify-center space-x-2"
      >
        vanilla webauthn ログイン
      </button>
    </form>
    <div class="mt-8 pt-6 border-t border-gray-200">
      <div class="flex items-center space-x-2 text-sm text-gray-600">
        <a href="register.html">登録はこちら</a>
      </div>
    </div>
    <script>
      window.PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable().then(
        (result) => {
          if (!result) {
            console.error(
              "No platform authenticator found. Ifyour OS does not come with one, try using devtools to set one up."
            );
          }
        }
      );

      let startConditionalRequest = async () => {
        if (window.PublicKeyCredential.isConditionalMediationAvailable) {
          console.log("Conditional UI is understood by the browser");
          if (
            !(await window.PublicKeyCredential.isConditionalMediationAvailable())
          ) {
            console.error(
              "Conditional UI is understood by your browser but not available"
            );
            return;
          }
        } else {
          if (!navigator.credentials.conditionalMediationSupported) {
            console.error(
              "Your browser does not implement Conditional UI (are you running the right chrome/safari version with the right flags?)"
            );
            return;
          } else {
            console.log(
              "This browser understand the old version of Conditional UI feature detection"
            );
          }
        }

        try {
          let credential = await navigator.credentials.get({
            signal: new AbortController().signal,
            publicKey: {
              challenge: new Uint8Array([1, 2, 3, 4]),
              //timeout:324441, },
              mediation: "conditional",
            },
          });
          if (credential) {
            console.log("ログイン成功\n" + credential);
          } else {
            console.error("Credential returned null");
          }
        } catch (error) {
          if (error.name == "AbortError") {
            console.log("request aborted");
            return;
          }
          console.error(error.toString());
        }
      };

      // let startNormalRequest = () => {
      //     console.log('starting webauthn conditional ui request');
      //     navigator.credentials.get({
      //         publicKey: { // don't do this in production!
      //         challenge: new Uint8Array([1, 2, 3, 4]) },
      //     }).then(credential => {
      //         if (credential) {
      //             let username = String.fromCodePoint(...new Uint8Array(credential.response.userHandle));
      //             window.location = "site.html?username=" + username; }
      //         else {
      //             console.error("Credential returned null");
      //         }
      //     }).catch(error => {
      //         console.error(error.toString());
      //     }).finally(() => {
      //         startConditionalRequest();
      //     });
      // };

      startConditionalRequest();
    </script>
  </body>
</html>
